!function(){function e(e){e||(e=this),e.closest(".comment-form")&&e.closest(".comment-form").dataset.login||new t(e)}class t{constructor(e){(this.editor=e,this.contentArea=e.querySelector(".content-area"),this.addLinkPopup=e.querySelector(".popup.link"),this.addImagePopup=e.querySelector(".popup.image"),this.editLinkPopup=e.querySelector(".popup.link-edit"),this.currentSelection=null,this.emojiPopup=this.editor.querySelector(".emoji-popup"),this.emojiMenu=this.editor.querySelector(".emoji-menu"),this.emojiList=this.editor.querySelector(".emoji-selected-set"),this.emojiSetMenu=this.emojiMenu.querySelector(".emoji-sets"),this.emojiSetShadows=this.emojiMenu.querySelector(".emoji-set-shadows"),this.exportField=e.querySelector(".export"),this.exportTimer=null,e.classList.contains("disabled"))||(console.log("editor initialized",this.editor,this.contentArea),this.editorButton={bold:()=>{document.execCommand("bold",!1,""),this.export()},italic:()=>{document.execCommand("italic",!1,""),this.export()},underline:()=>{document.execCommand("underline",!1,""),this.export()},strikethrough:()=>{document.execCommand("strikeThrough",!1,""),this.export()},h2:()=>{document.execCommand("formatBlock",!1,"h2"),this.export()},h3:()=>{document.execCommand("formatBlock",!1,"h3"),this.export()},link:function(){var e=this.addLinkPopup;e.querySelector("#text-text").value=this.getSelectionText()||"",e.querySelector("#text-url").value="",this.saveSelection(),e.show()},image:function(){var e=this.addImagePopup;e.querySelector("#text-url").value="",this.saveSelection(),e.show()},emoji:()=>{this.saveSelection(),this.emojiSetMenu.children[0].click(),this.emojiPopup.show()}},document.execCommand("defaultParagraphSeparator",!1,"p"),e.querySelectorAll(".toolbar>button").forEach(e=>{this.editorButton.hasOwnProperty(e.dataset.action)?(console.log("    button inititalized",e),e.addEventListener("click",this.editorButton[e.dataset.action].bind(this))):console.log("    button failed init",e)}),this.addLinkPopup.querySelector(".button-insert").addEventListener("click",this.addLink.bind(this)),this.addLinkPopup.querySelector(".button-cancel").addEventListener("click",this.addLinkPopup.hide),this.editLinkPopup.querySelector(".button-save").addEventListener("click",this.saveLink.bind(this)),this.editLinkPopup.querySelector(".button-cancel").addEventListener("click",this.editLinkPopup.hide),this.addImagePopup.querySelector(".button-insert").addEventListener("click",this.addImage.bind(this)),this.addImagePopup.querySelector(".button-cancel").addEventListener("click",this.addImagePopup.hide),this.contentArea.addEventListener("click",this.editorClick.bind(this)),this.contentArea.addEventListener("copy",e=>{var t=e.clipboardData||window.clipboardData;console.log(t),console.log(t.getData("text")),console.log("paste html",t.getData("text/html"));var o=document.getSelection();t.setData("lospec-editor","true");const i=o.getRangeAt(0),n=document.createElement("div");n.appendChild(i.cloneContents());const r=n.innerHTML;event.clipboardData.setData("text/html",r),e.preventDefault()}),this.contentArea.addEventListener("paste",e=>{var t=e.clipboardData||window.clipboardData;console.log("paste text",t.getData("text")),t.getData("lospec-editor")?console.log("data from lospec"):(console.log("external data",t.getData("text")),document.execCommand("insertText",!1,t.getData("text")),e.preventDefault()),this.export()}),this.emojiSetMenu.addEventListener("wheel",e=>{console.log("scrolled",this.emojiSetMenu.scrollLeft,this.emojiSetMenu.scrollWidth-this.emojiSetMenu.offsetWidth);var t=e.deltaY>0?1:e.deltaY<0?-1:0;this.emojiSetMenu.scrollBy(10*t,0),this.emojiSetShadows.className="emoji-set-shadows",this.emojiSetMenu.scrollLeft<=0?this.emojiSetShadows.classList.add("left"):this.emojiSetMenu.scrollLeft>=this.emojiSetMenu.scrollWidth-this.emojiSetMenu.offsetWidth&&this.emojiSetShadows.classList.add("right"),e.preventDefault()}),this.emojiSetMenu.dispatchEvent(new CustomEvent("wheel",{deltaY:0})),this.emojiSetMenu.addEventListener("click",e=>{var t=e.target;if("LI"==t.tagName&&(t=t.children[0]),t.classList.contains("emoji")){if(t.classList.contains("selected"))return;ajax("/emoji/editor/"+t.dataset.set,e=>{e.success&&(this.emojiList.innerHTML=e.html,this.emojiSetMenu.querySelector(".selected")&&this.emojiSetMenu.querySelector(".selected").classList.remove("selected"),t.classList.add("selected"))})}}),this.emojiList.addEventListener("click",e=>{console.log(e.target,e.target==this.emojiList);var t=e.target;if("LI"==t.tagName&&(t=t.children[0]),t.classList.contains("emoji")){console.log("chose emoji",t),this.restoreSelection();var o=t.cloneNode(!0);document.execCommand("insertHTML",!1,o.outerHTML+"&nbsp"),this.emojiPopup.hide(),this.export()}}),e.addEventListener("keyup",this.export.bind(this)),this.contentArea.addEventListener("blur",()=>{this.export.bind(this)(!0)}),this.contentArea.addEventListener("keydown",e=>{if(console.log("press",e.keyCode),39==e.keyCode)console.log("right arrow",window.getSelection(),window.getSelection().anchorNode.parentElement);else if(13==e.keyCode&&this.editor.dataset.blocklinebreaks)return e.preventDefault()}))}addLink(){console.log("inserting link",this.currentSelection);var e=this.addLinkPopup.querySelector("#text-url").value,t=this.addLinkPopup.querySelector("#text-text").value;if(!/^(http:\/\/|https:\/\/)/.test(e))return console.log(this.addLinkPopup),this.addLinkPopup.querySelector(".error").innerHTML="Url doesn't look right",this.addLinkPopup.querySelector(".error").classList.remove("anim-errorshake"),void setTimeout(()=>{this.addLinkPopup.querySelector(".error").classList.add("anim-errorshake")},10);this.restoreSelection(),t.length<1&&(t=e);var o='<a href="'+e+'" target="_blank">'+t+"</a>";this.contentArea.focus(),document.execCommand("insertHTML",!1,o),this.contentArea.appendChild(document.createTextNode("")),this.addLinkPopup.hide(),this.export()}addImage(){console.log("inserting image",this.currentSelection),this.restoreSelection();var e='<img class="inline-image" src="'+this.addImagePopup.querySelector("#text-url").value+'" />';this.contentArea.focus(),document.execCommand("insertHTML",!1,e),this.addImagePopup.hide(),this.export()}editorClick(e){if("A"==e.target.tagName){if(console.log("clicked inside link"),e.target.classList.contains("selected"))return;this.hideLinkTools(),e.target.classList.add("selected");var t=this.editor.querySelector(".link-tools").cloneNode(!0);t.classList.remove("template"),t=e.target.appendChild(t),setTimeout(()=>{t.classList.add("shown")},10),t.querySelector(".edit").addEventListener("click",this.editLink.bind(this)),t.querySelector(".delete").addEventListener("click",this.removeLink.bind(this))}else console.log("hiding links"),this.contentArea.querySelectorAll(".link-tools").forEach(e=>e.parentNode.removeChild(e)),this.contentArea.querySelectorAll("a.selected").forEach(e=>e.classList.remove("selected"))}hideLinkTools(){this.contentArea.querySelectorAll(".link-tools").forEach(e=>e.parentNode.removeChild(e)),this.contentArea.querySelectorAll("a.selected").forEach(e=>e.classList.remove("selected"))}editLink(e){var t=this.contentArea.querySelector("a.selected"),o=this.editLinkPopup;o.querySelector("#text-url").value=t.href,o.querySelector("#text-text").value=t.innerText,o.show(),e.stopPropagation()}removeLink(e){var t=this.editor.querySelector("a.selected");t.outerHTML=t.innerText,e.stopPropagation(),this.export()}saveLink(){var e=this.editor.querySelector("a.selected");console.log("edit",this.editor.querySelector(".content-area a.selected")),e.href=this.editLinkPopup.querySelector("#text-url").value,e.innerHTML=this.editLinkPopup.querySelector("#text-text").value,this.contentArea.querySelectorAll("a.selected").forEach(e=>e.classList.remove("selected")),this.editLinkPopup.hide(),this.export()}saveSelection(){var e;if(window.getSelection){var t=window.getSelection();console.log("sell",t,t.getRangeAt,t.rangeCount,t.getRangeAt&&t.rangeCount),t.getRangeAt&&t.rangeCount&&(console.log("gettin"),e=t.getRangeAt(0))}else document.selection&&document.selection.createRange?e=document.selection.createRange():(console.log("error getting selection"),e=null);console.log("saving selection",e),this.currentSelection=e}restoreSelection(){var e=this.currentSelection;if(e)if(window.getSelection){var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else document.selection&&e.select&&e.select()}getCaretPosition(){var e,t,o=this.contentArea,i=0;if(window.getSelection)(e=window.getSelection()).rangeCount&&(t=e.getRangeAt(0)).commonAncestorContainer.parentNode==o&&(i=t.endOffset);else if(document.selection&&document.selection.createRange&&(t=document.selection.createRange()).parentElement()==o){var n=document.createElement("span");o.insertBefore(n,o.firstChild);var r=t.duplicate();r.moveToElementText(n),r.setEndPoint("EndToEnd",t),i=r.text.length}return i}getSelectionText(){var e="";return window.getSelection?e=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(e=document.selection.createRange().text),e}export(e){var t=1==e?0:500;clearTimeout(this.exportTimer),this.exportTimer=setTimeout(()=>{this.exportField.value=this.contentArea.innerHTML,this.contentArea.dispatchEvent(new CustomEvent("export"))},t)}}HTMLElement.prototype.initCheckbox=e,window.onload=(()=>document.querySelectorAll(".editor").forEach(t=>e(t)))}(),function(){var e=document.querySelector(".comment-form");if(e)if(e.dataset.login)e.addEventListener("click",e=>{document.querySelector(".popup.sign-up").show(e),e.preventDefault()});else{var t=document.querySelector(".comment-form .submit-bar .reply-bar div:first-child"),o=document.querySelector(".comment-form .submit-bar .reply-bar .clear-reply"),i=document.querySelector(".comment-form .button-submit"),n=document.querySelector(".comment-form .editor .export"),r=document.querySelector(".comment-form .editor .content-area"),s=document.querySelector(".comment-list"),l=document.querySelector('.comment-form input[name="reply-id"]');i.addEventListener("click",e=>{s.querySelectorAll(".comment-container.new").forEach(e=>e.classList.remove("new"));var t={comment:n.value};console.log("comment has reply? ",l.value,l.value.length,l.value.length>3);var c=l.value.length>3;c&&(t.reply=l.value),i.disabled=!0;var d=window.location.pathname;document.querySelector(".comment-form").action&&(d=document.querySelector(".comment-form").action),console.log("action",d,window.location.pathname),ajax(d,t,e=>{if(e.success){if(c){for(var t=document.querySelector("#comment-"+l.value).closest(".comment-container");t.nextElementSibling&&t.nextElementSibling.classList.contains("child-comment");)t=t.nextElementSibling;t.insertAdjacentHTML("afterend",e.html),location.hash="#comment-"+l.value}else s.insertAdjacentHTML("afterbegin",e.html);r.innerHTML="<div></div>",n.value="<div></div>",o.click(),console.log("added new comment"),toast.show("Comment posted","check"),setTimeout(()=>{s.querySelectorAll(".comment-container.animate").forEach(e=>e.classList.remove("animate"))},1e3)}else e.error&&toast.show(e.error,"x");a()}),e.preventDefault()}),s.addEventListener("click",e=>{if(e.target.classList.contains("reply-button")){console.log("reply");var o=e.target.closest(".comment-container"),i=o.dataset.id;l.value=i;var n=o.dataset.author,s=o.querySelector(".comment-data .comment-html").innerText;t.innerHTML="<span>Replying to @"+n+":</span> "+s,setTimeout(function(){r.focus()},0),document.querySelector(".comment-form .submit-bar .reply-bar").style.visibility="visible",console.log("reply",o,i,n,s,t)}}),o.addEventListener("click",e=>{document.querySelector(".comment-form .submit-bar .reply-bar").style.visibility="hidden",t.innerHTML="",l.value=""}),r.addEventListener("keyup",a),r.addEventListener("paste",a),r.addEventListener("change",a),r.addEventListener("export",a)}else console.log("comment form not initialized");function a(){var e=r.innerText.length>1,t=r.querySelectorAll("img.inline-image").length>0,o=r.querySelectorAll("img.emoji").length>0;console.log("checking submit button",e,t,o),i.disabled=!(e||t||o)}}();